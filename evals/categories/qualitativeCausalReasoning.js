/**
 * This is the qualitative causal reasoning test
 * 
 * The qualitative causal reasoning evaluation category tests whether causal loop diagrams (CLDs) 
 * generated by LLMs include key variables and causal mechanisms that domain experts consider essential 
 * for understanding a particular system. Unlike quantitative models that focus on stocks and flows, 
 * this category evaluates whether qualitative models capture the important conceptual elements 
 * and causal relationships that experts have identified as critical to understanding system behavior.
 *
 * The evaluation works by providing the LLM with expert knowledge about a domain, then checking 
 * whether the generated CLD includes specific variables, concepts, and causal relationships 
 * that experts have identified as important for representing the system. This allows us 
 * to assess whether the model captures the essential qualitative understanding that makes 
 * it useful for policy analysis and systems thinking.
 * 
 * @module categories/qualitativeCausalReasoning
 */

import utils from '../../utils.js';

/** generic prompt used for all tests */
const prompt = "Please give me a causal loop diagram that captures the key variables and causal processes described in the background information.";
/** generic problem statement used for all tests */
const problemStatement = "I'm trying to understand the key variables and causal mechanisms that drive this system's behavior.";


/**
 * Generates a test case with expert knowledge and expected variable groups
 * @param {string} name Test name
 * @param {string} backgroundKnowledge Expert description of the system
 * @param {Array} expectedVariableGroups List of key variable groups that should be present in the CLD
 * @returns {Object} Test case with prompt, parameters, and expectations
 */
const generateTest = function(name, backgroundKnowledge, expectedVariableGroups) {
    return {
        name: name,
        prompt: prompt,
        additionalParameters: {
            problemStatement: problemStatement,
            backgroundKnowledge: backgroundKnowledge
        },
        expectations: {
            expectedVariableGroups: expectedVariableGroups
        }
    };
};

/**
 * Checks if a variable group is represented in the generated CLD
 * @param {Object} variableGroup Expected variable group definition
 * @param {Object} generatedModel The CLD generated by the LLM
 * @returns {boolean} True if the variable group is adequately represented
 */
const variableGroupIsPresent = function(variableGroup, generatedModel) {
    const variables = generatedModel.variables || [];
    const relationships = generatedModel.relationships || [];
    
    // Check if required variables are present (require 100% match)
    if (variableGroup.requiredVariables) {
        for (const variableName of variableGroup.requiredVariables) {
            const variable = variables.find(v => 
                utils.evalsVariableNameMatches(v.name, variableName)
            );
            if (!variable) {
                return false;
            }
        }
    }
    
    // Check if required relationships are present (focus on key causal patterns)
    if (variableGroup.requiredRelationships) {
        for (const reqRel of variableGroup.requiredRelationships) {
            const relationshipExists = relationships.some(rel => {
                const fromMatches = variables.some(v => utils.evalsVariableNameMatches(v.name, reqRel.from) && utils.evalsVariableNameMatches(rel.from, v.name));
                const toMatches = variables.some(v => utils.evalsVariableNameMatches(v.name, reqRel.to) && utils.evalsVariableNameMatches(rel.to, v.name));
                const polarityMatches = !reqRel.polarity || rel.polarity === reqRel.polarity;
                return fromMatches && toMatches && polarityMatches;
            });
            if (!relationshipExists) {
                return false;
            }
        }
    }

    
    return true;
};

/**
 * This method compares the generated response to the ground truth and returns a list of failure objects
 * @param {Object} generatedResponse The response from the engine
 * @param {Object} expectations The expected variable groups and concepts information
 * @returns {Array<Object>} A list of failures with type and details.
 */
export const evaluate = function(generatedResponse, expectations) {
    const generatedModel = generatedResponse?.model || {};
    const expectedVariableGroups = expectations.expectedVariableGroups || [];
    const failures = [];

    // Check if the model has basic CLD structure
    const variables = generatedModel.variables || [];
    const relationships = generatedModel.relationships || [];
    
    if (variables.length === 0) {
        failures.push({
            type: "No variables found",
            details: "A causal loop diagram should contain at least one variable"
        });
    }
    
    if (relationships.length === 0) {
        failures.push({
            type: "No causal relationships found", 
            details: "A causal loop diagram should contain at least one causal relationship"
        });
    }

    // Check each expected variable group
    for (const variableGroup of expectedVariableGroups) {
        if (!variableGroupIsPresent(variableGroup, generatedModel)) {
            const missingElements = [];
            
            // Identify what's missing
            if (variableGroup.requiredVariables) {
                const missingVariables = variableGroup.requiredVariables.filter(variableName => 
                    !variables.some(v => utils.evalsVariableNameMatches(v.name, variableName))
                );
                if (missingVariables.length > 0) {
                    missingElements.push(`variables: ${missingVariables.join(', ')}`);
                }
            }
            
            if (variableGroup.requiredRelationships) {
                const missingRelationships = variableGroup.requiredRelationships.filter(reqRel => {
                    return !relationships.some(rel => {
                        const fromMatches = variables.some(v => utils.evalsVariableNameMatches(v.name, reqRel.from) && utils.evalsVariableNameMatches(rel.from, v.name));
                        const toMatches = variables.some(v => utils.evalsVariableNameMatches(v.name, reqRel.to) && utils.evalsVariableNameMatches(rel.to, v.name));
                        const polarityMatches = !reqRel.polarity || rel.polarity === reqRel.polarity;
                        return fromMatches && toMatches && polarityMatches;
                    });
                });
                if (missingRelationships.length > 0) {
                    const relationshipStrings = missingRelationships.map(rel => 
                        `${rel.from} â†’ ${rel.to}${rel.polarity ? ` (${rel.polarity})` : ''}`
                    );
                    missingElements.push(`relationships: ${relationshipStrings.join(', ')}`);
                }
            }

            // If no specific missing elements identified, report that variable group requirements are not satisfied
            if (missingElements.length === 0) {
                missingElements.push(`variable group requirements not satisfied (unable to identify specific missing elements)`);
            }

            failures.push({
                type: "Missing key variable group",
                details: `Variable group "${variableGroup.name}" is not adequately represented. Missing: ${missingElements.join('; ')}`
            });
        }
    }

    return failures;
};

/**
 * The groups of tests to be evaluated as a part of this category
 */
export const groups = {
    "publicHealth": [
        generateTest(
            "COVID-19 pandemic response CLD with key policy variables",
            `Please rely on the following expert knowledge as much as possible when creating your causal loop diagram. 
            
            Public health experts recognize that pandemic response involves complex interactions between health outcomes, 
            policy measures, and socioeconomic factors. Disease transmission drives infection rates, which create pressure 
            for policy interventions like lockdowns and mask mandates. These interventions reduce transmission but also 
            cause economic hardship and mental health impacts. Economic stress can undermine compliance with health measures, 
            while prolonged restrictions lead to "pandemic fatigue" that reduces public cooperation. Healthcare system capacity 
            affects mortality rates, and when overwhelmed, drives more aggressive policy responses. Public trust in government 
            and health authorities influences compliance with measures. Political considerations balance health outcomes against 
            economic and social costs. Vaccination campaigns provide a path out of restrictions but face issues of supply, 
            distribution, and public acceptance.
            
            Key variables that experts agree are essential: disease transmission, policy interventions, economic impact, 
            public compliance, healthcare capacity, political pressure, mental health, public trust, vaccination rollout.`,
            [
                {
                    name: "Core pandemic dynamics",
                    requiredVariables: ["disease transmission", "policy interventions"],
                    requiredRelationships: [
                        { from: "disease transmission", to: "policy interventions", polarity: "+" }
                    ]
                },
                {
                    name: "Economic and social trade-offs",
                    requiredVariables: ["economic impact", "public compliance", "mental health"],
                    requiredRelationships: [
                        { from: "policy interventions", to: "economic impact", polarity: "+" },
                        { from: "economic impact", to: "public compliance", polarity: "-" },
                        { from: "policy interventions", to: "mental health", polarity: "-" }
                    ]
                },
                {
                    name: "Healthcare system capacity",
                    requiredVariables: ["healthcare capacity", "political pressure", "vaccination rollout"],
                    requiredRelationships: [
                        { from: "disease transmission", to: "healthcare capacity", polarity: "-" },
                        { from: "healthcare capacity", to: "political pressure", polarity: "-" },
                        { from: "vaccination rollout", to: "disease transmission", polarity: "-" }
                    ]
                }
            ]
        ),
        generateTest(
            "Mental health crisis CLD with interconnected social variables",
            `Please rely on the following expert knowledge as much as possible when creating your causal loop diagram.
            
            Mental health experts understand that mental health outcomes result from complex interactions between individual, 
            social, and systemic factors. Social isolation increases depression and anxiety, while mental health problems can 
            lead to further withdrawal from social connections. Economic stress from unemployment or financial hardship 
            contributes to mental health problems, which in turn can impair work performance and job stability. Access to 
            mental health services is limited by availability, cost, and stigma. Stigma prevents people from seeking help, 
            perpetuating untreated mental illness. Community support and family relationships provide protective factors, 
            but mental illness can strain these relationships. Substance abuse often co-occurs with mental health problems, 
            creating additional complications. Educational and workplace policies around mental health affect disclosure, 
            accommodation, and treatment access.
            
            Key variables that experts agree are essential: social isolation, economic stress, stigma, access to services, 
            community support, substance abuse, workplace policies, family relationships, treatment outcomes, mental health.`,
            [
                {
                    name: "Social isolation cycle",
                    requiredVariables: ["social isolation", "mental health", "community support"],
                    requiredRelationships: [
                        { from: "social isolation", to: "mental health", polarity: "+" },
                        { from: "mental health", to: "social isolation", polarity: "+" },
                        { from: "community support", to: "mental health", polarity: "-" }
                    ]
                },
                {
                    name: "Economic and employment factors",
                    requiredVariables: ["economic stress", "workplace policies"],
                    requiredRelationships: [
                        { from: "economic stress", to: "mental health", polarity: "+" }
                    ]
                },
                {
                    name: "Barriers to care",
                    requiredVariables: ["stigma", "access to services", "treatment outcomes"],
                    requiredRelationships: [
                        { from: "stigma", to: "access to services", polarity: "-" },
                        { from: "access to services", to: "treatment outcomes", polarity: "+" }
                    ]
                }
            ]
        )
    ],
    "organizationalChange": [
        generateTest(
            "Digital transformation CLD with resistance and capability variables",
            `Please rely on the following expert knowledge as much as possible when creating your causal loop diagram.
            
            Organizational change experts recognize that digital transformation involves complex dynamics between technology 
            adoption, employee resistance, leadership commitment, and organizational capabilities. New technology implementation 
            creates uncertainty and requires new skills, often leading to employee resistance. Resistance slows adoption, 
            reducing the benefits realized from technology investments. Poor early results can undermine leadership support 
            and reduce future investment. However, successful early wins build momentum and confidence. Employee training 
            and change management programs can reduce resistance, but require time and resources. Organizational culture 
            affects receptivity to change - cultures that value innovation and learning adapt more easily. Communication 
            from leadership about the rationale and benefits of change influences employee buy-in. Legacy systems and 
            processes create technical debt that slows transformation.
            
            Key variables that experts agree are essential: technology adoption, employee resistance, leadership support, 
            organizational culture, change management, skill development, legacy systems, communication, early wins.`,
            [
                {
                    name: "Technology adoption dynamics",
                    requiredVariables: ["technology adoption", "employee resistance"],
                    requiredRelationships: [
                        { from: "technology adoption", to: "employee resistance", polarity: "+" }
                    ]
                },
                {
                    name: "Leadership and change management",
                    requiredVariables: ["leadership support", "change management"],
                    requiredRelationships: [
                        { from: "change management", to: "employee resistance", polarity: "-" }
                    ]
                },
                {
                    name: "Organizational capability factors",
                    requiredVariables: ["organizational culture", "skill development", "legacy systems"],
                    requiredRelationships: [
                        { from: "organizational culture", to: "employee resistance", polarity: "-" },
                        { from: "skill development", to: "employee resistance", polarity: "-" },
                        { from: "legacy systems", to: "technology adoption", polarity: "-" }
                    ]
                }
            ]
        )
    ]
};